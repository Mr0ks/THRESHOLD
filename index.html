<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>THRESHOLD</title>
<link rel="icon" type="image/png" href="door.png" />
<style>
:root { --boot-bg:#000; --boot-fg:#fff; --intro-red:#d20000; }
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;background:#000;overflow:hidden;color:#fff;font-family:ui-monospace,monospace;}
.startScreen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#000;color:#fff;cursor:pointer;font-size:clamp(20px,3vw,28px);user-select:none;opacity:1;transition:opacity 1.5s ease;z-index:20}
.fadeOut{opacity:0!important}
.intro{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#000;text-align:center;flex-direction:column;z-index:10}
.introText,.presenting,.title{position:absolute;left:50%;transform:translateX(-50%);text-transform:uppercase;opacity:0;transition:opacity 2s ease-in-out}
.introText{top:50%;color:#fff;font-weight:600;font-size:clamp(18px,3vw,26px)}
.presenting{top:50%;color:#fff;font-weight:600;font-family:ui-monospace,monospace;font-size:clamp(20px,3vw,28px);letter-spacing:2px;transition:opacity 2s ease-in-out,top 2s ease-in-out;z-index:2}
.title{top:50%;left:50%;transform:translate(-50%,-50%);color:var(--intro-red);font-weight:900;white-space:nowrap;font-size:clamp(56px,16vw,220px);text-shadow:0 0 0 #f00;transition:opacity 2s ease-in-out,text-shadow 1.2s ease-in-out;z-index:1}
.skipButton{position:fixed;bottom:30px;right:30px;background:rgba(255,255,255,0.1);border:1px solid #fff;padding:10px 18px;font-size:16px;cursor:pointer;color:#fff;border-radius:6px;transition:background .3s,opacity .5s;z-index:9999}
.skipButton:hover{background:rgba(255,255,255,0.3)}
.dialogue{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:#000;padding:60px;text-align:center;flex-direction:column;z-index:8}
.dialogueText{max-width:900px;font-size:clamp(18px,2.5vw,22px);color:#fff;line-height:1.5;white-space:pre-line;opacity:1;transition:opacity 2s ease-in-out}
.pressEnter{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;font-size:clamp(20px,3vw,30px);color:#fff;background:#000;opacity:0;transition:opacity 2s ease-in-out;text-align:center}
.boot,.progressStage{position:fixed;inset:0;background:var(--boot-bg);color:var(--boot-fg);font-family:ui-monospace,Menlo,Consolas,monospace;padding:14px;overflow:auto;line-height:1.2;display:none}
.bootLine{white-space:pre;font-size:14px;margin-bottom:2px}
.progressLine{white-space:pre;font-size:14px}

/* XP Desktop */
#xpVideo{display:none;position:fixed;inset:0;width:100%;height:100%;object-fit:cover;z-index:200;background:#000;}
#xpDesktop{display:none;position:fixed;inset:0;background:url('bliss.png') center/cover no-repeat;cursor:url('cursor.cur'),auto;z-index:100;}
.taskbar{
  position:absolute;bottom:0;left:0;width:100%;height:40px;
  background:linear-gradient(#245edb,#1b47a6);
  border-top:1px solid #0a2d91;
  display:flex;align-items:center;justify-content:space-between;
  padding:0 10px;font-family:Tahoma,Arial;font-size:13px;color:#fff;
  box-shadow:inset 0 1px #3c7af3;
}
.startbtn{
  display:flex;align-items:center;gap:6px;
  background:linear-gradient(#6dd46d,#3aa83a);
  border:1px solid #0f490f;border-radius:4px;
  padding:3px 12px;font-weight:bold;color:#fff;
  font-family:Tahoma;
  box-shadow:inset 0 1px #a7fca7;
  cursor:pointer;
}
.startbtn:hover{background:linear-gradient(#7fe87f,#46b946);}
.startbtn::before{
  content:"";
  display:inline-block;
  width:16px;height:16px;
  background:url('https://win98icons.alexmeub.com/icons/png/windows-0.png') center/cover no-repeat;
}
#clock{font-family:Tahoma;font-size:13px;text-shadow:1px 1px 1px #000;}

/* Desktop icons */
.icon{position:absolute;width:80px;text-align:center;color:#fff;font-family:Tahoma;font-size:13px;text-shadow:1px 1px 2px #000;cursor:default;}
.icon img{width:48px;height:48px;display:block;margin:0 auto;}

/* Notification balloon */
#balloon{
  display:none;
  position:absolute;
  bottom:60px;right:20px;
  width:240px;background:#fff;border:1px solid #555;border-radius:6px;
  padding:8px;color:#000;font-family:Tahoma;font-size:13px;
  box-shadow:0 2px 4px rgba(0,0,0,.5);cursor:pointer;
}

/* Windows / Popups */
.window{
  position:absolute;
  background:#ece9d8;
  border:2px solid #0a246a;
  width:300px;
  display:none;
  z-index:150;
  box-shadow:0 4px 10px rgba(0,0,0,0.4);
  resize:both;
  overflow:hidden;
  min-width:220px;
  min-height:160px;
}
.window.large{width:600px;height:500px;}
.window.medium{width:500px;height:400px;}
.window .titlebar{
  background:linear-gradient(#4c7cd2,#2453a6);
  color:#fff;
  padding:4px 6px;
  font-family:Tahoma;
  font-size:13px;
  cursor:move;
  user-select:none;
}
.window .content{padding:10px;color:#000;font-family:Tahoma;font-size:13px;overflow-y:auto;max-height:450px;}
.window .close{float:right;cursor:pointer;font-weight:bold;color:#fff;}
.window .close:hover{color:#ff0000;}

/* Start Menu */
#startMenu{
  position:absolute;
  bottom:40px;
  left:0;
  width:200px;
  background:#ece9d8;
  border:2px solid #0a246a;
  display:none;
  z-index:160;
  box-shadow:0 4px 10px rgba(0,0,0,0.4);
}
.startMenuItem{
  padding:8px 12px;
  cursor:pointer;
  font-family:Tahoma;
  font-size:13px;
  color:#000;
  border-bottom:1px solid #ccc;
}
.startMenuItem:hover{background:#d4d0c8;}

/* Death Screen (legacy, mostly unused now) */
#deathScreen{
  position:fixed;
  inset:0;
  background:#000;
  display:none;
  align-items:center;
  justify-content:center;
  flex-direction:column;
  z-index:10000;
  color:#d20000;
  font-family:ui-monospace,monospace;
  text-align:center;
}
#deathText{
  font-size:clamp(40px,8vw,120px);
  font-weight:900;
  text-shadow:0 0 20px #d20000;
  margin-bottom:40px;
  animation:pulse 1s infinite;
}
@keyframes pulse{
  0%,100%{opacity:1;}
  50%{opacity:0.7;}
}
#deathInfo{
  font-size:clamp(18px,3vw,28px);
  margin-top:30px;
  line-height:1.8;
}
#finalMessage{
  max-width:800px;
  font-size:clamp(16px,2vw,20px);
  margin-top:40px;
  padding:20px;
  border:2px solid #d20000;
  background:rgba(210,0,0,0.1);
  line-height:1.6;
}

/* Email styles */
.email{background:#fff;border:1px solid #ccc;padding:8px;margin:5px 0;cursor:pointer;}
.email:hover{background:#f0f0f0;}
.email.unread{font-weight:bold;border-left:3px solid #0066cc;}

/* Settings styles */
.settingItem{padding:8px;border-bottom:1px solid #ccc;cursor:pointer;}
.settingItem:hover{background:#d4d0c8;}

/* Puzzle input */
.puzzleInput{padding:6px;margin:5px;border:1px solid #666;font-family:Tahoma;width:200px;}
.puzzleBtn{padding:6px 12px;background:#4c7cd2;color:#fff;border:none;cursor:pointer;font-family:Tahoma;}
.puzzleBtn:hover{background:#3a6bb8;}

/* ASCEND overlay */
#ascendOverlay{
  position:fixed;
  inset:0;
  background:#000;
  display:none;
  align-items:center;
  justify-content:center;
  z-index:20000;
}
#ascendText{
  font-family:ui-monospace,monospace;
  font-size:clamp(40px,8vw,120px);
  color:#ffffff;
  text-shadow:0 0 10px #ff0000;
  animation:ascendGlitch 0.15s infinite, ascendFade 3s forwards;
}
@keyframes ascendGlitch{
  0%{transform:translate(0,0);}
  25%{transform:translate(-2px,1px);}
  50%{transform:translate(2px,-1px);}
  75%{transform:translate(-1px,-2px);}
  100%{transform:translate(0,0);}
}
@keyframes ascendFade{
  0%{opacity:0;}
  100%{opacity:1;}
}
</style>
</head>

<body>
<div id="startScreen" class="startScreen">Click anywhere to begin...</div>
<div id="intro" class="intro" style="display:none;">
  <div id="introText" class="introText"></div>
  <div id="presenting" class="presenting">PRESENTING...</div>
  <div id="doorTitle" class="title">THRESHOLD</div>
</div>
<button id="skipIntro" class="skipButton" style="display:none;">Skip Intro</button>
<button id="skipDialogue" class="skipButton" style="display:none;">Skip Dialogue</button>
<div id="dialogue" class="dialogue"><div id="dialogueText" class="dialogueText"></div></div>
<div id="pressEnter" class="pressEnter">Press ENTER ‚Äî Clara's Laptop</div>
<div id="boot" class="boot"></div>
<div id="progressStage" class="progressStage">
  <div class="bootLine">:: Starting THRESHOLD environment</div>
  <div class="bootLine">:: Checking services: network OK, display OK, input OK</div><br>
  <div id="pLine" class="progressLine">[                    ] 0%</div>
</div>

<!-- XP Boot and Desktop -->
<video id="xpVideo" src="lol.mp4"></video>
<div id="xpDesktop">
  <div class="icon" style="top:40px;left:40px;">
    <img src="https://win98icons.alexmeub.com/icons/png/computer_explorer-4.png" alt="My Computer">
    <br>My Computer
  </div>
  <div class="icon" style="top:140px;left:40px;">
    <img src="https://win98icons.alexmeub.com/icons/png/directory_open_file_mydocs-5.png" alt="My Documents">
    <br>My Documents
  </div>
  <div class="icon" style="top:240px;left:40px;">
    <img src="https://win98icons.alexmeub.com/icons/png/recycle_bin_full-5.png" alt="Recycle Bin">
    <br>Recycle Bin
  </div>
  <div class="icon" style="top:340px;left:40px;">
    <img src="https://win98icons.alexmeub.com/icons/png/directory_closed-4.png" alt="File Explorer">
    <br>File Explorer
  </div>
  <div id="balloon">
    <strong>New hardware found</strong><br>
    Click here to install drivers.
  </div>
  <div id="errWindow" class="window">
    <div class="titlebar">Error <span class="close" onclick="closeErr()">X</span></div>
    <div class="content">A problem has been detected.<br><br><button onclick="closeErr()">OK</button></div>
  </div>
  <div class="taskbar">
    <div class="startbtn" id="startBtn">Start</div>
    <div id="clock"></div>
  </div>
  <div id="startMenu">
    <div class="startMenuItem" onclick="openWindow('email')">Outlook Express</div>
    <div class="startMenuItem" onclick="openWindow('settings')">Control Panel</div>
    <div class="startMenuItem" onclick="openWindow('notepad')">Notepad</div>
    <div class="startMenuItem" onclick="openWindow('calculator')">Calculator</div>
    <div class="startMenuItem" onclick="openWindow('internet')">Internet Explorer</div>
    <div class="startMenuItem" onclick="openWindow('phone')">Phone</div>
    <div class="startMenuItem" onclick="openWindow('explorer')">Windows Explorer</div>
    <div class="startMenuItem" onclick="openWindow('appstore')">App Store</div>
    <div class="startMenuItem" id="decryptorMenuItem" onclick="openWindow('decryptor')" style="display:none;">File Decryptor</div>
    <div class="startMenuItem" onclick="openWindow('recycle')">Recycle Bin</div>
    <div class="startMenuItem" id="puzzleMenuItem" onclick="openPuzzleWindow()" style="display:none;">Locked File</div>
  </div>
</div>

<!-- Game Windows -->
<div id="emailWindow" class="window large">
  <div class="titlebar">Outlook Express - Inbox <span class="close" onclick="closeWindow('emailWindow')">X</span></div>
  <div class="content" id="emailContent"></div>
</div>

<div id="appstoreWindow" class="window medium">
  <div class="titlebar">App Store <span class="close" onclick="closeWindow('appstoreWindow')">X</span></div>
  <div class="content" id="appstoreContent"></div>
</div>

<div id="settingsWindow" class="window medium">
  <div class="titlebar">Control Panel <span class="close" onclick="closeWindow('settingsWindow')">X</span></div>
  <div class="content" id="settingsContent"></div>
</div>

<div id="notepadWindow" class="window medium">
  <div class="titlebar">Notepad <span class="close" onclick="closeWindow('notepadWindow')">X</span></div>
  <div class="content" id="notepadContent"></div>
</div>

<div id="calculatorWindow" class="window">
  <div class="titlebar">Calculator <span class="close" onclick="closeWindow('calculatorWindow')">X</span></div>
  <div class="content" id="calculatorContent"></div>
</div>

<div id="internetWindow" class="window large">
  <div class="titlebar">Internet Explorer <span class="close" onclick="closeWindow('internetWindow')">X</span></div>
  <div class="content" id="internetContent"></div>
</div>

<div id="recycleWindow" class="window medium">
  <div class="titlebar">Recycle Bin <span class="close" onclick="closeWindow('recycleWindow')">X</span></div>
  <div class="content" id="recycleContent"></div>
</div>

<div id="phoneWindow" class="window medium">
  <div class="titlebar">Phone <span class="close" onclick="closeWindow('phoneWindow')">X</span></div>
  <div class="content" id="phoneContent"></div>
</div>

<div id="explorerWindow" class="window large">
  <div class="titlebar">Windows Explorer <span class="close" onclick="closeWindow('explorerWindow')">X</span></div>
  <div class="content" id="explorerContent"></div>
</div>

<div id="decryptorWindow" class="window medium">
  <div class="titlebar">File Decryptor <span class="close" onclick="closeWindow('decryptorWindow')">X</span></div>
  <div class="content" id="decryptorContent"></div>
</div>

<div id="puzzleWindow" class="window">
  <div class="titlebar">Locked File <span class="close" onclick="closeWindow('puzzleWindow')">X</span></div>
  <div class="content" id="puzzleContent"></div>
</div>

<!-- Death Screen (legacy) -->
<div id="deathScreen">
  <div id="deathText">YOU DIED</div>
  <div id="deathInfo">investigator<br>-1979-2025-<br>death: unknown</div>
  <div id="finalMessage"></div>
</div>

<!-- ASCEND overlay -->
<div id="ascendOverlay">
  <div id="ascendText">ASCEND</div>
</div>

<audio id="xpStart" src="start.mp3"></audio>
<audio id="xpErr" src="error.mp3"></audio>
<audio id="scaryAudio" src="scary.mp3"></audio>

<script>
// ---------- AUDIO ----------
const introAudio=new Audio('sounds/intro.mp3');
const talkAudio=new Audio('sounds/introtalk.mp3');
[introAudio,talkAudio].forEach(a=>{a.preload='auto';a.load();a.loop=false;a.autoplay=false;});

// ---------- ELEMENTS ----------
const startScreen=document.getElementById('startScreen');
const intro=document.getElementById('intro');
const introText=document.getElementById('introText');
const presenting=document.getElementById('presenting');
const door=document.getElementById('doorTitle');
const skipIntroBtn=document.getElementById('skipIntro');
const skipDlgBtn=document.getElementById('skipDialogue');
const dialogue=document.getElementById('dialogue');
const dialogueText=document.getElementById('dialogueText');
const pressEnter=document.getElementById('pressEnter');
const bootEl=document.getElementById('boot');
const pLine=document.getElementById('pLine');

// ---------- STATE ----------
let introSkipped=false,dialogueActive=false,dialogueSkipped=false,typerId=null;

// ---------- START ----------
startScreen.addEventListener('click',()=>{startScreen.classList.add('fadeOut');setTimeout(()=>{startScreen.style.display='none';startIntro();},1500);});

// ---------- INTRO ----------
function startIntro(){
  intro.style.display='flex';
  skipIntroBtn.style.display='block';
  introAudio.currentTime=0;introAudio.volume=1;introAudio.play().catch(()=>{});
  const lines=[
    "This game is protected by an MIT license.",
    "This game is based on Wayward and other movies.",
    "Contains flashing lights, loud sounds, and psychological horror."
  ];
  lines.forEach((text,i)=>{
    const t=i*9000;
    setTimeout(()=>{if(introSkipped)return;introText.textContent=text;introText.style.opacity=1;setTimeout(()=>{introText.style.opacity=0;},5000);},t+(i===0?500:0));
  });
  setTimeout(()=>{if(!introSkipped)presenting.style.opacity=1;},27000);
  setTimeout(()=>{if(!introSkipped)presenting.style.top="38%";},27050);
  setTimeout(()=>{if(!introSkipped){door.style.opacity=1;door.style.textShadow='0 0 25px #f00';}},29000);
  setTimeout(()=>{if(!introSkipped)fadeOutIntroAndStartDialogue();},36000);
}
function fadeOutIntroAndStartDialogue(){
  skipIntroBtn.style.display='none';presenting.style.opacity=0;door.style.opacity=0;
  const fade=setInterval(()=>{introAudio.volume=Math.max(0,introAudio.volume-0.06);if(introAudio.volume<=0){introAudio.pause();clearInterval(fade);}},30);
  setTimeout(()=>{intro.style.display='none';startDialogue();},300);
}
skipIntroBtn.addEventListener('click',()=>{if(introSkipped)return;introSkipped=true;fadeOutIntroAndStartDialogue();});

// ---------- DIALOGUE ----------
function startDialogue(){
  dialogue.style.display='flex';skipDlgBtn.style.display='block';dialogueActive=true;dialogueSkipped=false;
  talkAudio.currentTime=0;talkAudio.volume=1;talkAudio.play().catch(()=>{});
  const storyText=`This story begins in the City of Pines ‚Äî a quiet place where mist clings to the streets and secrets hide behind every window.
You are a young investigator, called to examine a murder that defies logic: no signs of struggle, no trace of poison, no clue of how it happened.

Inside the dimly lit apartment, you find Clara, a devoted member of Higher Heaven ‚Äî a healing cult that once promised salvation, now steeped in blood and mystery. She lies lifeless on the floor. Her laptop glows faintly beside her, the screen still open‚Ä¶ as if she was in the middle of something she shouldn‚Äôt have seen.

Your task: uncover what really happened to Clara`;
  dialogueText.textContent="";let idx=0;clearInterval(typerId);
  typerId=setInterval(()=>{if(!dialogueActive){clearInterval(typerId);return;}
  if(idx<storyText.length){dialogueText.textContent+=storyText[idx++];}else{clearInterval(typerId);}},40);
  setTimeout(()=>finishDialogue(),43000);
}
skipDlgBtn.addEventListener('click',()=>finishDialogue(true));
function finishDialogue(force=false){
  if(!dialogueActive)return;dialogueActive=false;if(typerId){clearInterval(typerId);typerId=null;}
  if(!dialogueSkipped||force){dialogueSkipped=true;skipDlgBtn.style.display='none';dialogueText.style.opacity=0;talkAudio.pause();
  setTimeout(()=>{dialogue.style.display='none';showPressEnter();},600);}
}

// ---------- PRESS ENTER ----------
function showPressEnter(){
  pressEnter.style.display='flex';pressEnter.style.opacity=1;
  document.addEventListener('keydown',function handler(e){
    if(e.key==='Enter'){document.removeEventListener('keydown',handler);
      pressEnter.style.opacity=0;setTimeout(()=>{pressEnter.style.display='none';startBoot();},500);}
  });
}

// ---------- BOOT ----------
const bootLines=[
  "[    0.000000] Linux version 6.8.1-arch",
  "[    0.002314] Booting system modules...",
  ":: Mounting /dev/sda1 to /mnt/root",
  ":: Starting udevd...",
  ":: Network manager started",
  ":: Boot complete ‚Äî Press ENTER to continue"
];
function startBoot(){
  bootEl.style.display='block';let i=0;(function append(){if(i>=bootLines.length)return;
  const l=document.createElement('div');l.className='bootLine';l.textContent=bootLines[i++];bootEl.appendChild(l);bootEl.scrollTop=bootEl.scrollHeight;
  if(i<bootLines.length)setTimeout(append,100);})();
  document.addEventListener('keydown',function handler(e){
    if(e.key==='Enter'&&bootEl.style.display==='block'){document.removeEventListener('keydown',handler);bootEl.style.display='none';showXPBoot();}});
}

// ---------- XP SEQUENCE ----------
const xpVideo=document.getElementById('xpVideo');
const xpDesktop=document.getElementById('xpDesktop');
const xpStart=document.getElementById('xpStart');
const xpErr=document.getElementById('xpErr');
const balloon=document.getElementById('balloon');
const errWin=document.getElementById('errWindow');
const clock=document.getElementById('clock');
const scaryAudio=document.getElementById('scaryAudio');

function showXPBoot(){
  xpVideo.style.display='block';
  xpVideo.play();
  xpVideo.onended=()=>{
    xpVideo.style.display='none';
    xpDesktop.style.display='block';
    xpStart.play();
    setTimeout(showBalloon,4000);
    startClock();
    initGame();
  };
}
function showBalloon(){
  balloon.style.display='block';
  balloon.addEventListener('click', ()=>{
    balloon.style.display='none';
    openErr();
  });
}
function openErr(){
  centerWindow(errWin);
  errWin.style.display='block';
  xpErr.play();
  makeDraggable(errWin);
}
function closeErr(){errWin.style.display='none';}
function startClock(){
  setInterval(()=>{
    const d=new Date();
    clock.textContent=d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
  },1000);
}

// ---------- HELPERS ----------
function centerWindow(win){
  const ww=window.innerWidth, wh=window.innerHeight;
  const rect=win.getBoundingClientRect();
  win.style.left=(ww/2-rect.width/2)+'px';
  win.style.top=(wh/2-rect.height/2-40)+'px';
}
function makeDraggable(win){
  const bar=win.querySelector('.titlebar');
  let offsetX=0,offsetY=0,isDown=false;
  bar.addEventListener('mousedown',e=>{
    isDown=true;
    offsetX=e.clientX - win.offsetLeft;
    offsetY=e.clientY - win.offsetTop;
    document.body.style.userSelect='none';
  });
  document.addEventListener('mouseup',()=>{isDown=false;document.body.style.userSelect='';});
  document.addEventListener('mousemove',e=>{
    if(!isDown)return;
    win.style.left=(e.clientX - offsetX)+'px';
    win.style.top=(e.clientY - offsetY)+'px';
  });
}

// ---------- HORROR GAME ----------
let gameStartTime=null;
let puzzlesSolved=0;
let cluesFound=[];
let finalPhraseUnlocked=false;
const totalPuzzles=5;
const finalPhrase="your lying on your back";
let decryptorInstalled=false;

// NEW STATE
let miniNotepadInstalled=false;
let numbersGameInstalled=false;
let fixedFileAvailable=false;
let finalAscendStarted=false;

// Start menu
const startBtn=document.getElementById('startBtn');
const startMenu=document.getElementById('startMenu');
startBtn.addEventListener('click',(e)=>{
  e.stopPropagation();
  startMenu.style.display=startMenu.style.display==='block'?'none':'block';
});
document.addEventListener('click',(e)=>{
  if(!startMenu.contains(e.target)&&!startBtn.contains(e.target)){
    startMenu.style.display='none';
  }
});

// Initialize game
function initGame(){
  gameStartTime=Date.now();
  // Initialize paymentPersonName before loading content
  if(!paymentPersonName){
    const firstNames=['Michael','David','James','Robert','John','William','Richard','Joseph'];
    const lastNames=['Smith','Johnson','Williams','Brown','Jones','Garcia','Miller','Davis'];
    paymentPersonName=`${firstNames[Math.floor(Math.random()*firstNames.length)]} ${lastNames[Math.floor(Math.random()*lastNames.length)]}`;
  }
  loadEmailContent();
  loadSettingsContent();
  loadNotepadContent();
  loadCalculatorContent();
  loadInternetContent();
  loadRecycleContent();
  loadPhoneContent();
  loadExplorerContent();
  loadDecryptorContent();
  loadAppStoreContent();
  
  // Random easter egg - sometimes show a glitch
  setTimeout(()=>{
    if(Math.random()>0.7){
      showGlitch();
    }
  },60000);

  // Random horror flashes
  setInterval(()=>{
    if(Math.random()>0.85 && !finalPhraseUnlocked){
      showHorrorFlash();
    }
  },30000);
  
  // (Removed old automatic final sequence timer; now only the explicit chain triggers the ending)
}

function showGlitch(){
  const glitch=document.createElement('div');
  glitch.style.cssText='position:fixed;inset:0;background:#000;z-index:9999;display:flex;align-items:center;justify-content:center;color:#d20000;font-size:24px;font-family:monospace;';
  glitch.textContent='SHE IS WATCHING';
  document.body.appendChild(glitch);
  setTimeout(()=>glitch.remove(),500);
}

// Window management
function openWindow(type){
  startMenu.style.display='none';
  const windows={
    email:'emailWindow',
    settings:'settingsWindow',
    notepad:'notepadWindow',
    calculator:'calculatorWindow',
    internet:'internetWindow',
    recycle:'recycleWindow',
    phone:'phoneWindow',
    explorer:'explorerWindow',
    appstore:'appstoreWindow',
    decryptor:'decryptorWindow'
  };
  const winId=windows[type];
  if(winId){
    const win=document.getElementById(winId);
    centerWindow(win);
    win.style.display='block';
    makeDraggable(win);
    if(type==='recycle') loadRecycleContent();
  }
}

function closeWindow(winId){
  const win=document.getElementById(winId);
  if(win)win.style.display='none';
}

// Email content with deleted folder
let cultPhoneNumber='';
let paymentPersonName='';
function loadEmailContent(){
  const content=document.getElementById('emailContent');
  const randomEmails=[
    {from:'Amazon',subject:'Your order has shipped',body:'Your order #12345 has been shipped and will arrive soon.',unread:false},
    {from:'Newsletter',subject:'Weekly Updates',body:'Check out our latest articles and updates.',unread:false},
    {from:'Bank',subject:'Account Statement',body:'Your monthly statement is now available online.',unread:true},
    {from:'Friend',subject:'Coffee this weekend?',body:'Want to grab coffee this Saturday? Let me know!',unread:false}
  ];
  
  // Generate random phone number for cult website
  const area=Math.floor(Math.random()*900)+100;
  const first=Math.floor(Math.random()*900)+100;
  const second=Math.floor(Math.random()*9000)+1000;
  cultPhoneNumber=`${area}-${first}-${second}`;
  
  const deletedEmails=[
    {from:'Spam',subject:'You won a prize!',body:'Congratulations! You have won $1,000,000!',unread:false},
    {from:'Unknown',subject:'hey clara this is the website we are happy you joined',body:`Hey Clara, this is the website we are happy you joined. Visit us at: www.higherheaven.org`,unread:false}
  ];
  
  content.innerHTML=`<div style="border:2px solid #7ba7ea;height:100%;display:flex;flex-direction:column;background:#ece9d8;font-family:Tahoma;">
    <div style="background:linear-gradient(#3b6fd8,#274a94);color:#fff;padding:6px 10px;font-weight:bold;">Outlook Express</div>
    <div style="flex:1;display:flex;">
      <div style="width:170px;background:#d4d0c8;padding:10px;border-right:1px solid #999;">
        <div onclick="showInbox()" style="padding:6px 8px;margin-bottom:6px;background:#fff;border:1px solid #999;cursor:pointer;">Inbox (${randomEmails.length})</div>
        <div onclick="showDeleted()" style="padding:6px 8px;margin-bottom:6px;background:#fff;border:1px solid #999;cursor:pointer;">Deleted Items (${deletedEmails.length})</div>
        <div style="padding:6px 8px;margin-bottom:6px;background:#f4f0e1;border:1px solid #bbb;color:#666;">Sent Items</div>
        <div style="padding:6px 8px;background:#f4f0e1;border:1px solid #bbb;color:#666;">Outbox</div>
      </div>
      <div style="flex:1;display:flex;flex-direction:column;">
        <div style="background:#f0f0f0;padding:6px 10px;border-bottom:1px solid #999;font-size:12px;color:#333;">File   Edit   View   Tools   Message   Help</div>
        <div id="emailView" style="flex:1;overflow:auto;background:#fff;"></div>
      </div>
    </div>
  </div>`;
  
  const emailView=document.getElementById('emailView');
  
  function renderInbox(){
    let rows='';
    randomEmails.forEach((email,i)=>{
      rows+=`<tr onclick="window.openInboxMessage(${i})" style="cursor:pointer;">
        <td style="padding:6px 8px;border-bottom:1px solid #eee;font-weight:${email.unread?'bold':'normal'};">${email.from}</td>
        <td style="padding:6px 8px;border-bottom:1px solid #eee;">${email.subject}</td>
      </tr>`;
    });
    emailView.innerHTML=`<table style="width:100%;border-collapse:collapse;font-size:12px;">
      <thead>
        <tr style="background:#f4f4f4;border-bottom:1px solid #ccc;">
          <th style="text-align:left;padding:6px 8px;width:30%;">From</th>
          <th style="text-align:left;padding:6px 8px;">Subject</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>`;
  }
  
  function renderDeleted(){
    let rows='';
    deletedEmails.forEach((email,i)=>{
      rows+=`<tr onclick="window.openDeletedMessage(${i})" style="cursor:pointer;">
        <td style="padding:6px 8px;border-bottom:1px solid #eee;">${email.from}</td>
        <td style="padding:6px 8px;border-bottom:1px solid #eee;">${email.subject}</td>
      </tr>`;
    });
    emailView.innerHTML=`<table style="width:100%;border-collapse:collapse;font-size:12px;">
      <thead>
        <tr style="background:#f4f4f4;border-bottom:1px solid #ccc;">
          <th style="text-align:left;padding:6px 8px;width:30%;">From</th>
          <th style="text-align:left;padding:6px 8px;">Subject</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>`;
  }
  
  function openMessage(email,backAction){
    emailView.innerHTML=`<div style="padding:12px;font-size:12px;">
      <button onclick="window.${backAction}()" style="padding:4px 8px;background:#4c7cd2;color:#fff;border:none;cursor:pointer;margin-bottom:10px;">Back</button>
      <div><strong>From:</strong> ${email.from}</div>
      <div><strong>Subject:</strong> ${email.subject}</div>
      <hr style="margin:12px 0;">
      <div style="white-space:pre-wrap;line-height:1.5;">${email.body}</div>
    </div>`;
  }
  
  window.showInbox=function(){
    renderInbox();
  };
  
  window.showDeleted=function(){
    renderDeleted();
  };
  
  window.openInboxMessage=function(idx){
    const email=randomEmails[idx];
    openMessage(email,'showInbox');
  };
  
  window.openDeletedMessage=function(idx){
    const email=deletedEmails[idx];
    openMessage(email,'showDeleted');
    if(idx===1&&!cluesFound.includes('cultEmail')){
      cluesFound.push('cultEmail');
      checkForPuzzleUnlock();
    }
  };
  
  renderInbox();
}

// Settings with hidden puzzle
function loadSettingsContent(){
  const content=document.getElementById('settingsContent');
  const settings=[
    'Display Properties',
    'Mouse Properties',
    'Keyboard Properties',
    'System Properties',
    'User Accounts',
    'Date and Time',
    'Network Connections'
  ];
  content.innerHTML='';
  settings.forEach((setting,i)=>{
    const div=document.createElement('div');
    div.className='settingItem';
    div.textContent=setting;
    div.addEventListener('click',()=>{
      if(setting==='Date and Time'){
        content.innerHTML='<div style="padding:10px;">'
          +'<button onclick="loadSettingsContent()" style="padding:5px 10px;margin-bottom:8px;background:#4c7cd2;color:#fff;border:none;cursor:pointer;">Back to Control Panel</button>'
          +'<div><strong>Current Date:</strong> 2025-01-15<br><strong>Time:</strong> 11:47 PM</div>'
          +'</div>';
        if(!cluesFound.includes('settings')){
          cluesFound.push('settings');
          checkForPuzzleUnlock();
        }
      }else{
        content.innerHTML=`<div style="padding:10px;">
          <button onclick="loadSettingsContent()" style="padding:5px 10px;margin-bottom:8px;background:#4c7cd2;color:#fff;border:none;cursor:pointer;">Back to Control Panel</button>
          <div>${setting} settings panel.<br><br>No changes made.</div>
        </div>`;
      }
    });
    content.appendChild(div);
  });
}

// Notepad with random reminders
function loadNotepadContent(){
  const content=document.getElementById('notepadContent');
  const reminders=[
    'Buy groceries - milk, bread, eggs',
    'Call dentist for appointment',
    'Pick up dry cleaning',
    'Check emails for important meetings',
    'Water the plants',
    'Return library books',
    'Schedule car maintenance',
    'Pay electricity bill'
  ];
  const randomReminders=reminders.sort(()=>Math.random()-0.5).slice(0,5);
  content.innerHTML=`<div style="font-family:Consolas,monospace;white-space:pre-wrap;background:#fff;padding:10px;border:1px solid #ccc;min-height:300px;">NOTES - Reminders

${randomReminders.join('\n')}</div>`;
  if(!cluesFound.includes('notepad')){
    cluesFound.push('notepad');
    checkForPuzzleUnlock();
  }
}

// Calculator with new 4532 trigger
function loadCalculatorContent(){
  const content=document.getElementById('calculatorContent');
  let display='0';
  let calcHTML=`<div style="background:#000;color:#0f0;padding:10px;font-family:monospace;font-size:20px;text-align:right;margin-bottom:10px;min-height:30px;" id="calcDisplay">${display}</div>`;
  calcHTML+=`<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:5px;">`;
  const buttons=['7','8','9','/','4','5','6','*','1','2','3','-','C','0','=','+'];
  buttons.forEach(btn=>{
    calcHTML+=`<button class="puzzleBtn" style="padding:15px;" onclick="calcButton('${btn}')">${btn}</button>`;
  });
  calcHTML+=`</div>`;
  // calcSecret div kept but unused (no hints)
  calcHTML+=`<div style="margin-top:15px;padding:10px;background:#fff3cd;border:1px solid #ffc107;display:none;" id="calcSecret"></div>`;
  content.innerHTML=calcHTML;
  
  window.calcButton=function(btn){
    const displayEl=document.getElementById('calcDisplay');
    if(btn==='C'){
      display='0';
    }else if(btn==='='){
      try{
        const result=eval(display);
        display=result.toString();
        // NEW: 4532 triggers fixed_savedvia.txt in Recycle Bin
        if(result===4532){
          createFixedSavedFile();
        }
      }catch(e){
        display='Error';
      }
    }else{
      if(display==='0'||display==='Error')display=btn;
      else display+=btn;
    }
    displayEl.textContent=display;
  };
}

// Internet Explorer with cult website and bank
let currentWebsite='search';
function loadInternetContent(){
  const content=document.getElementById('internetContent');
  
  // Generate random person name for bank payment if not already set
  if(!paymentPersonName){
    const firstNames=['Michael','David','James','Robert','John','William','Richard','Joseph'];
    const lastNames=['Smith','Johnson','Williams','Brown','Jones','Garcia','Miller','Davis'];
    paymentPersonName=`${firstNames[Math.floor(Math.random()*firstNames.length)]} ${lastNames[Math.floor(Math.random()*lastNames.length)]}`;
  }
  
  content.innerHTML=`<div style="background:#fff;padding:10px;">
    <div style="margin-bottom:10px;">
      <input type="text" id="urlBox" placeholder="Enter URL or search..." style="width:70%;padding:5px;" value="www.higherheaven.org">
      <button class="puzzleBtn" onclick="navigateWeb()" style="padding:5px 10px;">Go</button>
      <button class="puzzleBtn" onclick="webSearch()" style="padding:5px 10px;margin-left:5px;">Search</button>
    </div>
    <div id="webContent" style="margin-top:15px;"></div>
  </div>`;
  
  window.navigateWeb=function(){
    const url=document.getElementById('urlBox').value.toLowerCase();
    const content=document.getElementById('webContent');
    
    if(url.includes('higherheaven')||url.includes('higher-heaven')){
      showCultWebsite();
      currentWebsite='cult';
    }else if(url.includes('bank')||url.includes('mybank')||url.includes('onlinebanking')){
      showBankWebsite();
      currentWebsite='bank';
    }else if(url.includes('linkedin')||url.includes(paymentPersonName.toLowerCase().split(' ')[0])){
      showLinkedIn();
      currentWebsite='linkedin';
    }else{
      content.innerHTML=`<div style="padding:10px;"><p>Page not found.</p></div>`;
    }
  };
  
  window.webSearch=function(){
    const query=document.getElementById('urlBox').value.toLowerCase();
    const results=document.getElementById('webContent');
    
    if(query.includes(paymentPersonName.toLowerCase().split(' ')[0])||query.includes(paymentPersonName.toLowerCase().split(' ')[1])){
      results.innerHTML=`<div style="padding:10px;background:#e8f4f8;border:1px solid #0066cc;">
        <h3>Search Results for "${query}"</h3>
        <p><strong>LinkedIn Profile</strong><br>
        <a href="#" onclick="showLinkedIn(); return false;" style="color:#0066cc;">${paymentPersonName} - Professional Profile</a></p>
      </div>`;
      if(!cluesFound.includes('linkedin')){
        cluesFound.push('linkedin');
        checkForPuzzleUnlock();
      }
    }else{
      results.innerHTML=`<div style="padding:10px;"><p>No results found.</p></div>`;
    }
  };
  
  window.showCultWebsite=function(){
    const content=document.getElementById('webContent');
    content.innerHTML=`<div style="padding:20px;background:#f5f5f5;font-family:Arial;">
      <button onclick="loadInternetContent()" style="padding:5px 10px;margin-bottom:12px;background:#4c7cd2;color:#fff;border:none;cursor:pointer;">Back to Home</button>
      <h1 style="color:#2c5f2d;text-align:center;font-size:32px;">HIGHER HEAVEN</h1>
      <h2 style="color:#4a7c59;text-align:center;font-size:24px;">Animal Farms & Spiritual Community</h2>
      <div style="margin:30px 0;padding:20px;background:#fff;border:2px solid #2c5f2d;">
        <p style="font-size:18px;line-height:1.8;text-align:center;">
          Join us at Higher Heaven, where we combine sustainable animal farming with spiritual enlightenment.<br><br>
          Our community offers:<br>
          ‚Ä¢ Organic farming practices<br>
          ‚Ä¢ Spiritual retreats<br>
          ‚Ä¢ Community living<br>
          ‚Ä¢ Personal transformation<br><br>
          Experience the harmony of nature and spirit. Find your higher purpose.
        </p>
      </div>
      <div style="text-align:center;margin-top:40px;padding:20px;background:#2c5f2d;color:#fff;">
        <p style="font-size:20px;font-weight:bold;">Contact Us</p>
        <p style="font-size:18px;margin-top:10px;">Phone: ${cultPhoneNumber}</p>
      </div>
    </div>`;
    if(!cluesFound.includes('cultWebsite')){
      cluesFound.push('cultWebsite');
      checkForPuzzleUnlock();
    }
  };
  
  window.showBankWebsite=function(){
    const content=document.getElementById('webContent');
    const randomPayments=[
      {date:'2025-01-10',description:'Grocery Store',amount:'-$45.23'},
      {date:'2025-01-11',description:'Gas Station',amount:'-$32.50'},
      {date:'2025-01-12',description:'Restaurant',amount:'-$78.90'},
      {date:'2025-01-13',description:'Payment from '+paymentPersonName,amount:'-$1000.00'},
      {date:'2025-01-14',description:'Coffee Shop',amount:'-$5.75'},
      {date:'2025-01-15',description:'Online Purchase',amount:'-$129.99'}
    ];
    let paymentsHTML='<div style="padding:20px;background:#fff;">'
      +'<button onclick="loadInternetContent()" style="padding:5px 10px;margin-bottom:12px;background:#4c7cd2;color:#fff;border:none;cursor:pointer;">Back to Home</button>'
      +'<h2 style="color:#0066cc;">Account Transactions</h2>'
      +'<table style="width:100%;border-collapse:collapse;margin-top:20px;"><tr style="background:#0066cc;color:#fff;"><th style="padding:10px;text-align:left;border:1px solid #ccc;">Date</th><th style="padding:10px;text-align:left;border:1px solid #ccc;">Description</th><th style="padding:10px;text-align:right;border:1px solid #ccc;">Amount</th></tr>';
    randomPayments.forEach(p=>{
      paymentsHTML+=`<tr><td style="padding:8px;border:1px solid #ccc;">${p.date}</td><td style="padding:8px;border:1px solid #ccc;">${p.description}</td><td style="padding:8px;border:1px solid #ccc;text-align:right;color:${p.amount.startsWith('-')?'#d20000':'#006400'};font-weight:bold;">${p.amount}</td></tr>`;
    });
    paymentsHTML+='</table></div>';
    content.innerHTML=paymentsHTML;
    if(!cluesFound.includes('bank')){
      cluesFound.push('bank');
      checkForPuzzleUnlock();
    }
  };
  
  window.showLinkedIn=function(){
    const content=document.getElementById('webContent');
    content.innerHTML=`<div style="padding:20px;background:#fff;">
      <button onclick="loadInternetContent()" style="padding:5px 10px;margin-bottom:12px;background:#4c7cd2;color:#fff;border:none;cursor:pointer;">Back to Home</button>
      <h2 style="color:#0077b5;">LinkedIn Profile</h2>
      <div style="margin-top:20px;padding:15px;background:#f5f5f5;border:1px solid #ccc;">
        <h3>${paymentPersonName}</h3>
        <p>Professional Profile</p>
      </div>
    </div>`;
  };
  
  window.openPhoneApp=function(phoneNum){
    openWindow('phone');
    setTimeout(()=>{
      showPhoneMessages(phoneNum);
    },100);
  };
}

// Phone app with messages
let phoneMessages={};
function loadPhoneContent(){
  const content=document.getElementById('phoneContent');
  content.innerHTML=`<div style="padding:10px;">
    <h3>Phone Messages</h3>
    <p>Enter phone number to view messages:</p>
    <input type="text" id="phoneInput" placeholder="XXX-XXX-XXXX" style="padding:6px;width:200px;margin:10px 0;">
    <button class="puzzleBtn" onclick="checkPhoneNumber()">View Messages</button>
    <div id="phoneMessages" style="margin-top:15px;"></div>
  </div>`;
  
  window.checkPhoneNumber=function(){
    const phoneNum=document.getElementById('phoneInput').value.trim();
    const messagesDiv=document.getElementById('phoneMessages');
    
    if(phoneNum===cultPhoneNumber){
      showPhoneMessages(phoneNum);
    }else{
      messagesDiv.innerHTML='<div style="padding:10px;color:#d20000;">No messages found for this number.</div>';
    }
  };
  
  window.showPhoneMessages=function(phoneNum){
    const content=document.getElementById('phoneContent');
    const messagesDiv=document.getElementById('phoneMessages');
    if(!messagesDiv){
      content.innerHTML=`<div style="padding:10px;">
        <h3>Phone Messages - ${phoneNum}</h3>
        <div id="phoneMessages" style="margin-top:15px;"></div>
      </div>`;
    }
    const finalDiv=document.getElementById('phoneMessages')||content;
    finalDiv.innerHTML=`<div style="padding:10px;background:#fff;border:1px solid #ccc;">
      <button onclick="loadPhoneContent()" style="padding:5px 10px;margin-bottom:8px;background:#4c7cd2;color:#fff;border:none;cursor:pointer;">Back to Phone</button>
      <h4>Messages with ${phoneNum}</h4>
      <div style="margin-top:15px;padding:10px;background:#f0f0f0;border-left:3px solid #0066cc;">
        <strong>Clara:</strong> where is money<br>
        <small style="color:#666;">2025-01-13 10:23 AM</small>
      </div>
      <div style="margin-top:10px;padding:10px;background:#f0f0f0;border-left:3px solid #0066cc;">
        <strong>Clara:</strong> where is money<br>
        <small style="color:#666;">2025-01-13 2:15 PM</small>
      </div>
      <div style="margin-top:10px;padding:10px;background:#f0f0f0;border-left:3px solid #0066cc;">
        <strong>Clara:</strong> where is money<br>
        <small style="color:#666;">2025-01-13 5:47 PM</small>
      </div>
      <div style="margin-top:10px;padding:10px;background:#e8f5e9;border-left:3px solid #4caf50;">
        <strong>${phoneNum}:</strong> it will be there soon check the usb<br>
        <small style="color:#666;">2025-01-13 6:02 PM</small>
      </div>
      <div style="margin-top:10px;padding:10px;background:#f0f0f0;border-left:3px solid #0066cc;">
        <strong>Clara:</strong> where is money<br>
        <small style="color:#666;">2025-01-14 9:12 AM</small>
      </div>
    </div>`;
    if(!cluesFound.includes('phone')){
      cluesFound.push('phone');
      checkForPuzzleUnlock();
    }
  };
}

// Explorer app with D:/ drive and encrypted file + corrupted files + diary
function loadExplorerContent(){
  const content=document.getElementById('explorerContent');
  content.innerHTML=`<div style="border:2px solid #7ba7ea;font-family:Tahoma;height:100%;background:#ece9d8;">
    <div style="background:linear-gradient(#4d76d9,#2a4ca3);color:#fff;padding:6px 10px;font-weight:bold;">Windows Explorer</div>
    <div style="display:flex;height:360px;">
      <div style="width:190px;background:#d4d0c8;padding:8px;border-right:1px solid #999;overflow:auto;font-size:12px;">
        <div onclick="selectExplorerNode('desktop')" style="padding:4px;cursor:pointer;">Desktop</div>
        <div onclick="selectExplorerNode('mydocs')" style="padding:4px;cursor:pointer;">My Documents</div>
        <div onclick="selectExplorerNode('mycomputer')" style="padding:4px;cursor:pointer;font-weight:bold;">My Computer</div>
        <div style="margin-left:12px;">
          <div onclick="showDrive('C')" style="padding:4px;cursor:pointer;">Local Disk (C:)</div>
          <div onclick="showDrive('D')" style="padding:4px;cursor:pointer;">Local Disk (D:)</div>
        </div>
      </div>
      <div style="flex:1;display:flex;flex-direction:column;">
        <div style="background:#f0f0f0;padding:6px 10px;border-bottom:1px solid #999;font-size:12px;">Address: <span id="explorerPath">My Computer</span></div>
        <div id="filePane" style="flex:1;padding:10px;background:#fff;overflow:auto;font-size:12px;"></div>
        <div style="padding:8px;background:#f7f7f7;border-top:1px solid #ccc;font-size:12px;">
          <div style="font-weight:bold;">Search Companion</div>
          <input type="text" id="fileSearch" placeholder="Type exact file name..." style="padding:4px;width:65%;margin:6px 0;">
          <button class="puzzleBtn" onclick="searchFiles()" style="padding:4px 10px;">Search</button>
          <div id="searchResults" style="margin-top:6px;"></div>
        </div>
        <div id="statusBar" style="background:#d4d0c8;padding:4px 10px;border-top:1px solid #999;font-size:11px;">Ready</div>
      </div>
    </div>
  </div>`;
  
  const filePane=document.getElementById('filePane');
  const pathEl=document.getElementById('explorerPath');
  const statusEl=document.getElementById('statusBar');
  
  function renderMyComputer(){
    pathEl.textContent='My Computer';
    filePane.innerHTML=`<div style="display:flex;gap:20px;flex-wrap:wrap;">
      <div ondblclick="showDrive('C')" style="width:120px;text-align:center;cursor:pointer;">
        <img src="https://win98icons.alexmeub.com/icons/png/disk-2.png" alt="C:" style="width:48px;height:48px;"><br>Local Disk (C:)
      </div>
      <div ondblclick="showDrive('D')" style="width:120px;text-align:center;cursor:pointer;">
        <img src="https://win98icons.alexmeub.com/icons/png/disk-1.png" alt="D:" style="width:48px;height:48px;"><br>Local Disk (D:)
      </div>
    </div>`;
    statusEl.textContent='Objects: 2';
  }
  
  window.selectExplorerNode=function(node){
    if(node==='desktop'){
      pathEl.textContent='Desktop';
      filePane.innerHTML='<p>Empty workspace.</p>';
      statusEl.textContent='Objects: 0';
    }else if(node==='mydocs'){
      pathEl.textContent='My Documents';
      filePane.innerHTML=`<div style="display:flex;flex-direction:column;gap:6px;">
        <div ondblclick="openDiaryFile()" style="padding:6px;border:1px solid #ccc;background:#fff;cursor:pointer;">üìÑ Diary.txt</div>
      </div>`;
      statusEl.textContent='Objects: 1';
    }else{
      renderMyComputer();
    }
  };
  
  window.showDrive=function(drive){
    if(drive==='D'){
      pathEl.textContent='My Computer > Local Disk (D:)';
      filePane.innerHTML=`<div style="display:flex;flex-direction:column;gap:6px;">
        <div ondblclick="openArchiveFolder()" style="padding:6px;border:1px solid #ccc;background:#f8f8f8;cursor:pointer;">üìÅ Archive</div>
        <div style="padding:6px;border:1px solid #ccc;background:#f8f8f8;color:#999;">üìÅ System (access denied)</div>
        <div ondblclick="openCorruptedFile('dfj3K2.tmp')" style="padding:6px;border:1px solid #ccc;background:#fff;cursor:pointer;">üóé dfj3K2.tmp</div>
        <div ondblclick="openCorruptedFile('broken77.sys')" style="padding:6px;border:1px solid #ccc;background:#fff;cursor:pointer;">üóé broken77.sys</div>
        <div ondblclick="openCorruptedFile('ARCHIVE-99.bak')" style="padding:6px;border:1px solid #ccc;background:#fff;cursor:pointer;">üóé ARCHIVE-99.bak</div>
        <div ondblclick="openCorruptedFile('notes.old')" style="padding:6px;border:1px solid #ccc;background:#fff;cursor:pointer;">üóé notes.old</div>
        <div ondblclick="openCorruptedFile('x1x1x1.raw')" style="padding:6px;border:1px solid #ccc;background:#fff;cursor:pointer;">üóé x1x1x1.raw</div>
        <div ondblclick="openCorruptedFile('system_lock.err')" style="padding:6px;border:1px solid #ccc;background:#fff;cursor:pointer;">üóé system_lock.err</div>
      </div>`;
      statusEl.textContent='Objects: 8';
      if(!cluesFound.includes('encryptedFile')){
        cluesFound.push('encryptedFile');
        checkForPuzzleUnlock();
      }
    }else{
      pathEl.textContent='My Computer > Local Disk (C:)';
      filePane.innerHTML='<p>System files are hidden.</p>';
      statusEl.textContent='Objects: 0';
    }
  };
  
  window.openArchiveFolder=function(){
    pathEl.textContent='My Computer > Local Disk (D:) > Archive';
    filePane.innerHTML=`<div style="display:flex;flex-direction:column;gap:6px;">
      <div ondblclick="openTransfersFolder()" style="padding:6px;border:1px solid #ccc;background:#fffbe6;cursor:pointer;">üìÅ Transfers</div>
      <div style="padding:6px;border:1px solid #ccc;background:#f8f8f8;color:#999;">üìÅ Photos (empty)</div>
    </div>`;
    statusEl.textContent='Objects: 2';
  };
  
  window.openTransfersFolder=function(){
    pathEl.textContent='My Computer > Local Disk (D:) > Archive > Transfers';
    filePane.innerHTML=`<div style="padding:6px;border:1px solid #ccc;background:#fff3cd;">
      <div ondblclick="openEncryptedFile()" style="cursor:pointer;">üîí encrypted_file.dat</div>
      <p style="font-size:11px;color:#555;margin-top:6px;">Double-click to inspect.</p>
    </div>`;
    statusEl.textContent='Objects: 1';
  };
  
  window.openEncryptedFile=function(){
    filePane.innerHTML=`<div style="padding:12px;background:#fff3cd;border:2px solid #ffc107;">
      <p><strong>Encrypted File Detected</strong></p>
      <p>The system cannot read this archive. Use File Decryptor to attempt decryption.</p>
    </div>`;
    statusEl.textContent='Objects: 1';
  };
  
  window.openCorruptedFile=function(name){
    filePane.innerHTML=`<div style="padding:12px;background:#000;color:#0f0;font-family:Consolas,monospace;white-space:pre-wrap;">
${name}
--------------------
ÔøΩ‚ñí‚ñà‚ñí‚ñíÔøΩ‚ñí‚ñí‚ñí‚ñí‚ñí‚ñà‚ñì‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí
‚ñí‚ñí‚ñí‚ñíÔøΩ‚ñà‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñì‚ñí‚ñí‚ñí‚ñí‚ñí
‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñíÔøΩ‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí
DATA STREAM CORRUPTED
    </div>`;
    statusEl.textContent='1 item opened';
  };
  
  window.searchFiles=function(){
    const searchTerm=document.getElementById('fileSearch').value.toLowerCase().trim();
    const results=document.getElementById('searchResults');
    
    if(searchTerm===paymentPersonName.toLowerCase()){
      results.innerHTML=`<div style="padding:8px;border:1px solid #ccc;background:#fff;">
        <strong>Result:</strong>
        <div style="padding:5px;margin-top:6px;background:#fff3cd;border:1px solid #ffc107;cursor:pointer;" onclick="openLockedFile()">
          üîí ${paymentPersonName.toLowerCase().replace(' ','_')}_locked.txt
        </div>
      </div>`;
      if(!cluesFound.includes('lockedFile')){
        cluesFound.push('lockedFile');
        checkForPuzzleUnlock();
      }
    }else{
      results.innerHTML=`<div style="padding:6px;color:#333;">No indexed files found. The name must match exactly.</div>`;
    }
  };
  
  window.openLockedFile=function(){
    openPuzzleWindow();
  };
  
  window.openDiaryFile=function(){
    filePane.innerHTML=`<div style="padding:12px;background:#fff;border:1px solid #ccc;white-space:pre-wrap;font-family:Consolas,monospace;">
dear diary, i dont know what to do,
i lost my money,
my only choice is to stay with them
    </div>`;
    statusEl.textContent='Diary.txt';
  };
  
  renderMyComputer();
}

// Decryptor app ‚Äî now requires selecting file and decrypts to "4532"
function loadDecryptorContent(){
  const content=document.getElementById('decryptorContent');
  content.innerHTML=`<div style="padding:10px;">
    <h3>File Decryptor</h3>
    <p>Select encrypted file to decrypt:</p>
    <select id="decryptFileSelect" class="puzzleInput">
      <option value="">-- select file --</option>
      <option value="encrypted_file.dat">D:/Archive/Transfers/encrypted_file.dat</option>
      <option value="dfj3K2.tmp">dfj3K2.tmp</option>
      <option value="broken77.sys">broken77.sys</option>
    </select>
    <div style="margin:15px 0;">
      <button class="puzzleBtn" onclick="decryptFile()" style="padding:10px 20px;">Decrypt Selected</button>
    </div>
    <div id="decryptResult" style="margin-top:15px;"></div>
  </div>`;
  
  window.decryptFile=function(){
    const result=document.getElementById('decryptResult');
    const sel=document.getElementById('decryptFileSelect').value;
    if(!sel){
      result.innerHTML=`<div style="padding:10px;background:#f8d7da;border:1px solid #dc3545;color:#721c24;">No file selected.</div>`;
      return;
    }
    if(sel!=='encrypted_file.dat'){
      result.innerHTML=`<div style="padding:10px;background:#fff3cd;border:1px solid #ffc107;color:#856404;">This file cannot be decrypted.</div>`;
      return;
    }
    result.innerHTML=`<div style="padding:15px;background:#d4edda;border:2px solid #28a745;color:#155724;">
      <h4>‚úì File Decrypted Successfully</h4>
      <div style="margin-top:10px;padding:10px;background:#fff;border:1px solid #ccc;white-space:pre-wrap;font-family:monospace;">
4532
      </div>
    </div>`;
    if(!cluesFound.includes('decrypted')){
      cluesFound.push('decrypted');
      checkForPuzzleUnlock();
    }
  };
}

// Recycle Bin
function loadRecycleContent(){
  const content=document.getElementById('recycleContent');
  if(fixedFileAvailable){
    content.innerHTML=`<div style="padding:10px;">
      <h3>Recycle Bin</h3>
      <div ondblclick="openFixedSavedFile()" style="padding:6px;border:1px solid #ccc;background:#fff;cursor:pointer;margin-top:10px;">üìÑ fixed_savedvia.txt</div>
      <p style="font-size:11px;color:#666;margin-top:6px;">Double-click to open.</p>
    </div>`;
  }else{
    content.innerHTML=`<div style="padding:10px;">
      <h3>Recycle Bin</h3>
      <p>Empty</p>
    </div>`;
  }
}

function createFixedSavedFile(){
  if(!fixedFileAvailable){
    fixedFileAvailable=true;
    // If recycle window open, refresh contents
    if(document.getElementById('recycleWindow').style.display==='block'){
      loadRecycleContent();
    }
  }
}

function openFixedSavedFile(){
  const content=document.getElementById('recycleContent');
  content.innerHTML=`<div style="padding:10px;">
    <h3>fixed_savedvia.txt</h3>
    <p>This file is protected. Enter password:</p>
    <input type="text" id="fixedPassword" class="puzzleInput" placeholder="Enter password">
    <button class="puzzleBtn" onclick="checkFixedPassword()">Unlock</button>
    <div id="fixedResult" style="margin-top:10px;"></div>
  </div>`;
}

function checkFixedPassword(){
  const val=(document.getElementById('fixedPassword').value||'').trim().toLowerCase();
  const result=document.getElementById('fixedResult');
  if(val==='higherheaven'){
    result.innerHTML=`<div style="padding:10px;background:#fff;border:1px solid #ccc;white-space:pre-wrap;font-family:Consolas,monospace;">
you are lying on your back, crying to your mother, your mother turns to face you her mouth is wide open, there is a door inside her mouth, it OPENS.
    </div>`;
    if(!finalAscendStarted){
      finalAscendStarted=true;
      setTimeout(startAscendSequence,10000);
    }
  }else{
    result.innerHTML=`<div style="padding:10px;background:#f8d7da;border:1px solid #dc3545;color:#721c24;">Incorrect password.</div>`;
  }
}

// App Store
function loadAppStoreContent(){
  const content=document.getElementById('appstoreContent');
  if(!content)return;
  content.innerHTML=`<div style="padding:10px;">
    <h3>App Store</h3>
    <p>Browse and install desktop applications.</p>
    <div style="margin-top:15px;">
      <div style="padding:8px;border:1px solid #ccc;margin-bottom:8px;background:#fff;">
        <strong>Mini Notepad</strong><br>
        <small>Lightweight text editor.</small><br>
        <button class="puzzleBtn" id="miniNotepadBtn" onclick="installMiniNotepad()" style="margin-top:6px;">Install</button>
      </div>
      <div style="padding:8px;border:1px solid #ccc;margin-bottom:8px;background:#fff;">
        <strong>Numbers Game</strong><br>
        <small>Pointless little distraction.</small><br>
        <button class="puzzleBtn" id="numbersGameBtn" onclick="installNumbersGame()" style="margin-top:6px;">Install</button>
      </div>
      <div style="padding:8px;border:1px solid #ccc;margin-bottom:8px;background:#fff;">
        <strong>File Decryptor</strong><br>
        <small>Utility for handling encrypted data.</small><br>
        <button class="puzzleBtn" id="decryptorBtn" onclick="installDecryptor()" style="margin-top:6px;">Install</button>
      </div>
    </div>
    <div id="appstoreStatus" style="margin-top:12px;font-size:12px;color:#333;"></div>
  </div>`;

  window.installMiniNotepad=function(){
    const status=document.getElementById('appstoreStatus');
    const btn=document.getElementById('miniNotepadBtn');
    if(miniNotepadInstalled){
      status.textContent='Mini Notepad is already installed.';
      return;
    }
    status.textContent='Installing Mini Notepad...';
    setTimeout(()=>{
      miniNotepadInstalled=true;
      status.textContent='Mini Notepad installed.';
      btn.textContent='Installed';
      btn.disabled=true;
    },1000);
  };

  window.installNumbersGame=function(){
    const status=document.getElementById('appstoreStatus');
    const btn=document.getElementById('numbersGameBtn');
    if(numbersGameInstalled){
      status.textContent='Numbers Game is already installed.';
      return;
    }
    status.textContent='Installing Numbers Game...';
    setTimeout(()=>{
      numbersGameInstalled=true;
      status.textContent='Numbers Game installed.';
      btn.textContent='Installed';
      btn.disabled=true;
      showHorrorFlash();
    },1200);
  };

  window.installDecryptor=function(){
    const status=document.getElementById('appstoreStatus');
    const btn=document.getElementById('decryptorBtn');
    if(decryptorInstalled){
      status.textContent='File Decryptor is already installed.';
      return;
    }
    status.textContent='Installing File Decryptor...';
    setTimeout(()=>{
      decryptorInstalled=true;
      const item=document.getElementById('decryptorMenuItem');
      if(item)item.style.display='block';
      status.textContent='File Decryptor installed.';
      btn.textContent='Installed';
      btn.disabled=true;
    },1500);
  };
}

// Puzzle system
function checkForPuzzleUnlock(){
  // Unlock puzzle window after finding locked file
  if(cluesFound.includes('lockedFile')){
    if(!document.getElementById('puzzleWindow').dataset.unlocked){
      document.getElementById('puzzleWindow').dataset.unlocked='true';
      document.getElementById('puzzleMenuItem').style.display='block';
    }
  }
}

function openPuzzleWindow(){
  if(document.getElementById('puzzleWindow').dataset.unlocked){
    showPuzzle();
  }
}

function showPuzzle(){
  const content=document.getElementById('puzzleContent');
  content.innerHTML=`<div style="padding:10px;">
    <p><strong>Locked File - Requires Password</strong></p>
    <p>Enter the password (4 digits):</p>
    <input type="text" id="puzzleCode" class="puzzleInput" maxlength="4" placeholder="Enter 4 digits">
    <button class="puzzleBtn" onclick="checkPuzzleCode()">Unlock</button>
    <div id="puzzleResult" style="margin-top:10px;"></div>
  </div>`;
  const win=document.getElementById('puzzleWindow');
  centerWindow(win);
  win.style.display='block';
  makeDraggable(win);
  
  window.checkPuzzleCode=function(){
    const code=document.getElementById('puzzleCode').value.trim();
    const result=document.getElementById('puzzleResult');
    const phoneDigits=cultPhoneNumber.replace(/-/g,'').substring(0,4);
    
    if(code===phoneDigits){
      puzzlesSolved++;
      result.innerHTML='<div style="color:green;padding:10px;background:#d4edda;border:1px solid #28a745;">‚úì Password accepted. File unlocked.</div>';
      setTimeout(()=>{
        content.innerHTML=`<div style="padding:10px;white-space:pre-wrap;font-family:Consolas,monospace;">
FILE UNLOCKED

(no readable content)
        </div>`;
      },2000);
    }else{
      result.innerHTML='<div style="color:red;padding:10px;background:#f8d7da;border:1px solid #dc3545;">‚úó Access denied. The code is rejected by the system.</div>';
    }
  };
}

// Additional puzzles triggered by interactions (no hint message anymore)
let puzzleInteractions=0;
document.addEventListener('click',()=>{
  puzzleInteractions++;
});

// Random horror flash overlay
function showHorrorFlash(){
  const phrases=[
    'YOU CANT ESCAPE IT',
    'LET IT IN',
    'IT WILL FIND YOU'
  ];
  const overlay=document.createElement('div');
  overlay.style.cssText='position:fixed;inset:0;background:#000;z-index:9998;display:flex;align-items:center;justify-content:center;color:#d20000;font-size:32px;font-family:ui-monospace,monospace;letter-spacing:2px;';
  overlay.textContent=phrases[Math.floor(Math.random()*phrases.length)];
  document.body.appendChild(overlay);
  setTimeout(()=>overlay.remove(),600);
}

// Legacy final sequence (now unused, kept for safety)
let finalSequenceScheduled=false;
function triggerFinalSequence(){
  // no-op now; final path uses new ASCEND sequence
}

function showDeathScreen(){
  const deathScreen=document.getElementById('deathScreen');
  const finalMsg=document.getElementById('finalMessage');
  finalMsg.textContent=finalPhrase;
  deathScreen.style.display='flex';
}

// ASCEND final sequence
function startAscendSequence(){
  const overlay=document.getElementById('ascendOverlay');
  if(!overlay)return;
  overlay.style.display='flex';
  let flashes=0;
  const maxTime=3000;
  const interval=150;
  const start=Date.now();
  const flashInterval=setInterval(()=>{
    const t=Date.now()-start;
    if(t>=maxTime){
      clearInterval(flashInterval);
      overlay.style.background='#000';
      window.location.href='https://www.google.com';
      return;
    }
    overlay.style.background = (flashes%2===0)?'#000000':'#8b0000';
    flashes++;
  },interval);
  // Play scary audio
  if(scaryAudio){
    scaryAudio.currentTime=0;
    scaryAudio.play().catch(()=>{});
  }
}

// Make desktop icons clickable
document.querySelectorAll('.icon').forEach(icon=>{
  icon.style.cursor='pointer';
  icon.addEventListener('dblclick',()=>{
    const text=icon.textContent.trim();
    if(text.includes('My Documents')){
      openWindow('notepad'); // or explorer mydocs
      openWindow('explorer');
      selectExplorerNode('mydocs');
    }else if(text.includes('My Computer') || text.includes('File Explorer')){
      openWindow('explorer');
    }else if(text.includes('Recycle Bin')){
      openWindow('recycle');
    }
  });
});
</script>
</body>
</html>
