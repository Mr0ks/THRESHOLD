<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>THRESHOLD</title>
<link rel="icon" type="image/png" href="door.png" />
<style>
  :root{
    --boot-bg:#000; 
    --boot-fg:#fff; 
    --intro-red:#d20000;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{
    height:100%;
    background:#000;
    overflow:hidden;
    color:#fff;
    font-family:ui-monospace,monospace;
  }

  .startScreen {
    position:fixed; inset:0;
    display:flex; align-items:center; justify-content:center;
    background:#000; color:#fff; cursor:pointer;
    font-size:clamp(20px,3vw,28px);
    opacity:1; transition:opacity 1.5s ease;
    z-index:20;
  }
  .fadeOut{opacity:0!important;}

  .intro {
    position:fixed; inset:0;
    display:flex; align-items:center; justify-content:center;
    background:#000; text-align:center; z-index:10;
  }
  .introText {
    position:absolute;
    top:50%; left:50%;
    transform:translate(-50%,-50%);
    color:#fff; font-weight:600;
    text-transform:uppercase;
    opacity:0; font-size:clamp(18px,3vw,26px);
  }

  @keyframes fadeInOut {
    0% {opacity:0;} 
    20% {opacity:1;} 
    80% {opacity:1;} 
    100% {opacity:0;}
  }
  .fadeInOut {animation: fadeInOut 9s ease-in-out forwards;}

  .title {
    position:absolute;
    top:50%; left:50%;
    transform:translate(-50%,-50%);
    color:var(--intro-red);
    font-weight:900; text-transform:uppercase;
    opacity:0;
    font-size:clamp(56px,16vw,220px);
  }
  @keyframes doorFade {
    0% {opacity:0; text-shadow:0 0 0 #f00;}
    30% {opacity:1; text-shadow:0 0 25px #f00;}
    70% {opacity:1; text-shadow:0 0 25px #f00;}
    100% {opacity:0; text-shadow:0 0 0 #f00;}
  }
  .doorFadeAnim {animation: doorFade 10s ease-in-out forwards;}

  .dialogue {
    position:fixed; inset:0;
    display:none; align-items:center; justify-content:center;
    background:#000; padding:60px; text-align:center;
  }
  .dialogueText {
    max-width:900px;
    font-size:clamp(18px,2.5vw,22px);
    line-height:1.5; white-space:pre-line;
  }

  .entering {
    position:fixed; inset:0;
    display:none; align-items:center; justify-content:center;
    background:#000;
    font-size:clamp(22px,3vw,30px);
    color:#0f0;
    text-transform:uppercase;
    letter-spacing:2px;
    font-weight:600;
  }

  .boot, .progressStage {
    position:fixed; inset:0;
    background:var(--boot-bg); color:var(--boot-fg);
    padding:14px; overflow:auto; line-height:1.2;
    display:none;
  }
  .bootLine{white-space:pre; font-size:14px; margin-bottom:2px}
  .progressLine{white-space:pre; font-size:14px}

  .app{display:none; place-items:center; height:100%;
    background:#fff; font-size:24px; font-weight:600; color:#111;}
</style>
</head>
<body>

<div id="startScreen" class="startScreen">Click anywhere to begin...</div>

<div id="intro" class="intro" style="display:none;">
  <div id="introText" class="introText"></div>
  <div class="title" id="doorTitle">THRESHOLD</div>
</div>

<div id="dialogue" class="dialogue">
  <div id="dialogueText" class="dialogueText"></div>
</div>

<div id="entering" class="entering">[ENTERING CLARA'S LAPTOP]</div>

<div id="boot" class="boot"></div>
<div id="progressStage" class="progressStage">
  <div class="bootLine">:: Starting THRESHOLD environment</div>
  <div class="bootLine">:: Checking services: network OK, display OK, input OK</div><br>
  <div id="pLine" class="progressLine">[                    ] 0%</div>
</div>

<div id="app" class="app">[ Mail UI Loaded ]</div>

<script>
const startScreen=document.getElementById('startScreen');
const intro=document.getElementById('intro');
const introText=document.getElementById('introText');
const door=document.getElementById('doorTitle');
const bootEl=document.getElementById('boot');
const progressStage=document.getElementById('progressStage');
const app=document.getElementById('app');
const pLine=document.getElementById('pLine');
const dialogue=document.getElementById('dialogue');
const dialogueText=document.getElementById('dialogueText');
const entering=document.getElementById('entering');

let introAudio; 
let skipActive=false;
let introSkipped=false;

// PRELOAD intro audio
introAudio = new Audio('sounds/intro.mp3');
introAudio.preload = 'auto';
introAudio.load();

startScreen.addEventListener('click',()=>{
  startScreen.classList.add('fadeOut');
  setTimeout(()=>{
    startScreen.style.display='none';
    startIntro();
  },1500);
});

function startIntro(){
  intro.style.display='flex';
  introAudio.currentTime = 0;
  introAudio.volume = 1;
  introAudio.play();

  // Skip prompt
  const skipMsg=document.createElement('div');
  skipMsg.textContent='Press [S] to skip intro';
  Object.assign(skipMsg.style,{
    position:'absolute',bottom:'20px',right:'30px',fontSize:'16px',opacity:'0.6',
    fontFamily:'ui-monospace,monospace',pointerEvents:'none'
  });
  intro.appendChild(skipMsg);
  skipActive=true;
  document.addEventListener('keydown',handleSkip);

  const lines=[
    "This game is protected by an MIT license.",
    "This game is based on Wayward and other movies.",
    "Contains flashing lights, loud sounds, and psychological horror."
  ];

  const fadeDuration=9000;
  let delay=0;
  lines.forEach(text=>{
    setTimeout(()=>{
      if(introSkipped)return;
      introText.style.animation='none';
      void introText.offsetWidth;
      introText.textContent=text;
      introText.style.animation=`fadeInOut ${fadeDuration/1000}s ease-in-out forwards`;
    },delay);
    delay+=fadeDuration;
  });

  // Fade out intro music near end
  setTimeout(()=>{
    if(introSkipped)return;
    let fade=setInterval(()=>{
      if(introAudio.volume>0.05){introAudio.volume-=0.05;}
      else{introAudio.pause();clearInterval(fade);}
    },200);
  },27000);

  // Title fade
  setTimeout(()=>{
    if(introSkipped)return;
    door.classList.add('doorFadeAnim');
  },29000);

  // Move to "Entering Clara's Laptop"
  setTimeout(()=>{
    if(introSkipped)return;
    intro.style.display='none';
    showEnteringText();
  },41000);
}

/* ===== SKIP HANDLER ===== */
function handleSkip(e){
  if(!skipActive)return;
  if(e.key.toLowerCase()==='s'){
    introSkipped=true;
    skipActive=false;
    document.removeEventListener('keydown',handleSkip);
    if(introAudio){
      let fade=setInterval(()=>{
        if(introAudio.volume>0.05){introAudio.volume-=0.05;}
        else{introAudio.pause();clearInterval(fade);}
      },100);
    }
    intro.style.transition='opacity 1s ease';
    intro.style.opacity='0';
    setTimeout(()=>{
      intro.style.display='none';
      showEnteringText();
    },1000);
  }
}

/* ===== ENTERING TEXT + TRANSITION TO DIALOGUE ===== */
function showEnteringText(){
  entering.style.display='flex';
  entering.animate([{opacity:0},{opacity:1},{opacity:1},{opacity:0}],{
    duration:7000,easing:'ease-in-out',fill:'forwards'
  });

  // Fade out intro sound immediately
  if(introAudio && !introAudio.paused){
    let fadeOut=setInterval(()=>{
      if(introAudio.volume>0.05){introAudio.volume-=0.05;}
      else{introAudio.pause();clearInterval(fadeOut);}
    },100);
  }

  // Wait 7 seconds then fade into dialogue
  setTimeout(()=>{
    entering.style.display='none';
    startDialogue();
  },7000);
}

/* ===== DIALOGUE ===== */
function startDialogue(){
  dialogue.style.display='flex';
  const storyAudio=new Audio('sounds/introtalk.mp3');
  storyAudio.preload='auto';
  storyAudio.load();
  storyAudio.volume=0;
  storyAudio.play();

  // Fade in volume smoothly
  let fadeIn=setInterval(()=>{
    if(storyAudio.volume<1){storyAudio.volume+=0.05;}
    else{clearInterval(fadeIn);}
  },200);

  const storyText=`This story begins in the City of Pines — a quiet place where mist clings to the streets and secrets hide behind every window.
You are a young investigator, called to examine a murder that defies logic: no signs of struggle, no trace of poison, no clue of how it happened.

Inside the dimly lit apartment, you find Clara, a devoted member of Higher Heaven — a healing cult that once promised salvation, now steeped in blood and mystery. She lies lifeless on the floor. Her laptop glows faintly beside her, the screen still open… as if she was in the middle of something she shouldn’t have seen.

Your task: uncover what really happened to Clara`;

  dialogueText.textContent="";
  let idx=0;
  const speed=40;
  const typewriter=setInterval(()=>{
    if(idx<storyText.length){
      dialogueText.textContent+=storyText[idx++];
    }else{
      clearInterval(typewriter);
    }
  },speed);

  setTimeout(()=>{
    const fade=dialogue.animate([{opacity:1},{opacity:0}],{duration:1500,fill:'forwards'});
    fade.onfinish=()=>{
      dialogue.style.display='none';
      startBoot();
    };
  },43000);
}

/* ===== BOOT ===== */
const bootLines=[
 "[    0.000000] Linux version 6.8.1-arch",
 "[    0.002314] Booting system modules...",
 ":: Mounting /dev/sda1 to /mnt/root",
 ":: Starting udevd...",
 ":: Network manager started",
 ":: Boot complete — Press ENTER to continue"
];

function startBoot(){
  bootEl.style.display='block';
  let i=0;
  function appendBootLine(){
    if(i>=bootLines.length)return;
    const l=document.createElement('div');
    l.className='bootLine';
    l.textContent=bootLines[i++];
    bootEl.appendChild(l);
    bootEl.scrollTop=bootEl.scrollHeight;
    if(i<bootLines.length)setTimeout(appendBootLine,100);
  }
  appendBootLine();

  document.addEventListener('keydown',e=>{
    if(e.key==='Enter'&&bootEl.style.display==='block'){
      bootEl.style.display='none';
      progressStage.style.display='block';
      startProgress();
    }
  });
}

function startProgress(){
  let pct=0;const total=20;
  const t=setInterval(()=>{
    pct=Math.min(100,pct+Math.floor(Math.random()*8)+5);
    const filled=Math.round((pct/100)*total);
    const bar="["+ "#".repeat(filled).padEnd(total," ")+"] "+String(pct).padStart(2," ")+"%";
    pLine.textContent=bar;
    if(pct>=100){
      clearInterval(t);
      setTimeout(()=>{
        progressStage.style.display='none';
        app.style.display='grid';
      },300);
    }
  },120);
}
</script>
</body>
</html>
