<script>
const startScreen=document.getElementById('startScreen');
const intro=document.getElementById('intro');
const introText=document.getElementById('introText');
const door=document.getElementById('doorTitle');
const bootEl=document.getElementById('boot');
const progressStage=document.getElementById('progressStage');
const app=document.getElementById('app');
const pLine=document.getElementById('pLine');

startScreen.addEventListener('click',()=>{
  startScreen.classList.add('fadeOut');
  setTimeout(()=>{
    startScreen.style.display='none';
    startIntro();
  },1500);
});

function startIntro(){
  intro.style.display='flex';
  intro.style.background='#000';
  const audio=new Audio('sounds/intro.mp3');
  audio.volume=1; audio.play();

  const lines=[
    "This game is protected by an MIT license.",
    "This game is based on Wayward and other movies.",
    "Contains flashing lights, loud sounds, and psychological horror."
  ];

  const fadeDuration=9000;
  let delay=0;

  // Sequential white lines fade
  lines.forEach(text=>{
    setTimeout(()=>{
      introText.textContent=text;
      introText.style.opacity=0;
      introText.style.display='block';
      introText.style.animation='none';
      void introText.offsetWidth; // reflow
      introText.style.animation=`fadeInOut ${fadeDuration/1000}s ease-in-out forwards`;
    },delay);
    delay+=fadeDuration;
  });

  // 29 s — show THE DOOR
  setTimeout(()=>{
    introText.textContent='';
    door.style.opacity=0;
    door.classList.remove('doorFadeAnim');
    void door.offsetWidth;
    door.classList.add('doorFadeAnim');
  },29000);

  // 40 s — fade audio and switch to boot
  setTimeout(()=>{
    const fade=setInterval(()=>{
      if(audio.volume>0.05){audio.volume-=0.05;}
      else{clearInterval(fade);audio.pause();}
    },200);
    setTimeout(()=>{
      intro.style.display='none';
      startBoot();
    },2000);
  },40000);
}

/* ----- BOOT + APP same as before ----- */
const bootLines=[
 "[    0.000000] Linux version 6.8.1-arch",
 "[    0.002314] Booting system modules...",
 ":: Mounting /dev/sda1 to /mnt/root",
 ":: Starting udevd...",
 ":: Network manager started",
 ":: Boot complete — Press ENTER to continue"
];

function startBoot(){
  bootEl.style.display='block';
  let i=0;
  function appendBootLine(){
    if(i>=bootLines.length)return;
    const l=document.createElement('div');
    l.className='bootLine';
    l.textContent=bootLines[i++];
    bootEl.appendChild(l);
    bootEl.scrollTop=bootEl.scrollHeight;
    if(i<bootLines.length)setTimeout(appendBootLine,100);
  }
  appendBootLine();

  document.addEventListener('keydown',e=>{
    if(e.key==='Enter'&&bootEl.style.display==='block'){
      bootEl.style.display='none';
      progressStage.style.display='block';
      startProgress();
    }
  });
}

function startProgress(){
  let pct=0;const total=20;
  const t=setInterval(()=>{
    pct=Math.min(100,pct+Math.floor(Math.random()*8)+5);
    const filled=Math.round((pct/100)*total);
    const bar="["+ "#".repeat(filled).padEnd(total," ")+"] "+String(pct).padStart(2," ")+"%";
    pLine.textContent=bar;
    if(pct>=100){
      clearInterval(t);
      setTimeout(()=>{
        progressStage.style.display='none';
        app.style.display='grid';
      },300);
    }
  },120);
}
</script>
